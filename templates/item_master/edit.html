{% extends 'index.html' %}

{% block content %}
<div class="container-fluid px-4">
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">{{ 'Edit Item' if item else 'Create New Item' }}</h4>
        </div>
        <div class="card-body">
            <form id="item-form">
                {% if item %}
                <input type="hidden" name="id" value="{{ item.id }}">
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="item_code" class="form-label">Item Code *</label>
                            <input type="text" id="item_code" name="item_code" class="form-control" 
                                   value="{{ item.item_code if item else '' }}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="description" class="form-label">Description *</label>
                            <input type="text" id="description" name="description" class="form-control" 
                                   value="{{ item.description if item else '' }}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="item_type" class="form-label">Item Type</label>
                            <div class="input-group">
                                <select id="item_type" name="item_type" class="form-select" required>
                                    <option value="">Select Item Type</option>
                                    {% for item_type in item_types %}
                                        <option value="{{ item_type.type_name }}" 
                                                {% if item and item.item_type == item_type.type_name %}selected{% endif %}>
                                            {{ item_type.type_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newItemTypeModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="category_id" class="form-label">Category</label>
                            <div class="input-group">
                                <select id="category_id" name="category_id" class="form-select">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" 
                                            {{ 'selected' if item and item.category_id == category.id else '' }}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newCategoryModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="department_id" class="form-label">Department</label>
                            <div class="input-group">
                                <select id="department_id" name="department_id" class="form-select">
                                    <option value="">Select Department</option>
                                    {% for department in departments %}
                                    <option value="{{ department.department_id }}" 
                                            {{ 'selected' if item and item.department_id == department.department_id else '' }}>
                                        {{ department.departmentName }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newDepartmentModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="uom_id" class="form-label">UOM</label>
                            <div class="input-group">
                                <select id="uom_id" name="uom_id" class="form-select">
                                    <option value="">Select UOM</option>
                                    {% for uom in uoms %}
                                    <option value="{{ uom.UOMID }}" 
                                            {{ 'selected' if item and item.uom_id == uom.UOMID else '' }}>
                                        {{ uom.UOMName }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newUOMModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="min_level" class="form-label">Min Level</label>
                            <input type="number" id="min_level" name="min_level" class="form-control" 
                                   value="{{ item.min_level if item and item.min_level else '' }}" step="1" min="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="max_level" class="form-label">Max Level</label>
                            <input type="number" id="max_level" name="max_level" class="form-control" 
                                   value="{{ item.max_level if item and item.max_level else '' }}" step="1" min="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                       {{ 'checked' if item and item.is_active else '' }}>
                                <label class="form-check-label" for="is_active">
                                    <span id="status-label">{{ 'Active' if item and item.is_active else 'Inactive' }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                

                <!-- Raw Material Specific Fields -->
                <div id="raw-material-fields">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="price_per_kg" class="form-label">Price per KG</label>
                                <input type="number" id="price_per_kg" name="price_per_kg" class="form-control" 
                                       value="{{ item.price_per_kg if item and item.price_per_kg else '' }}" 
                                       step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finished Good Specific Fields -->
                <div id="finished-good-fields">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="machinery_id" class="form-label">Machinery</label>
                                <div class="input-group">
                                    <select id="machinery_id" name="machinery_id" class="form-select">
                                        <option value="">Select Machinery</option>
                                        {% for machine in machinery %}
                                        <option value="{{ machine.machineID }}" 
                                                {{ 'selected' if item and item.machinery_id == machine.machineID else '' }}>
                                            {{ machine.machineryName }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newMachineryModal">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="kg_per_unit" class="form-label">KG per Unit</label>
                                <input type="number" id="kg_per_unit" name="kg_per_unit" class="form-control" 
                                       value="{{ item.kg_per_unit if item and item.kg_per_unit else '' }}" 
                                       step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="units_per_bag" class="form-label">Units per Bag</label>
                                <input type="number" id="units_per_bag" name="units_per_bag" class="form-control" 
                                       value="{{ item.units_per_bag if item and item.units_per_bag else '' }}" 
                                       step="1" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="loss_percentage" class="form-label">Loss Percentage</label>
                                <input type="number" id="loss_percentage" name="loss_percentage" class="form-control" 
                                       value="{{ item.loss_percentage if item and item.loss_percentage else '' }}" 
                                       step="0.01" min="0" max="100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Make to Order</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="is_make_to_order" name="is_make_to_order" 
                                           {{ 'checked' if item and item.is_make_to_order else '' }}>
                                    <label class="form-check-label" for="is_make_to_order">
                                        <span id="mto-label">{{ 'Yes' if item and item.is_make_to_order else 'No' }}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allergens -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="form-label">Allergens</label>
                            <div class="allergen-checkboxes">
                                {% for allergen in allergens %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input allergen-checkbox" type="checkbox" 
                                           id="allergen_{{ allergen.allergens_id }}" 
                                           name="allergen_ids" 
                                           value="{{ allergen.allergens_id }}"
                                           {{ 'checked' if item and allergen in item.allergens else '' }}>
                                    <label class="form-check-label" for="allergen_{{ allergen.allergens_id }}">
                                        {{ allergen.name }}
                                    </label>
                                </div>
                                {% endfor %}
                                <div class="form-check form-check-inline">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#newAllergenModal">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Item
                        </button>
                        <a href="/item-master" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Item Type Modal -->
<div class="modal fade" id="newItemTypeModal" tabindex="-1" aria-labelledby="newItemTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newItemTypeModalLabel">Add New Item Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-item-type-form">
                    <div class="form-group">
                        <label for="new-item-type-name" class="form-label">Type Name *</label>
                        <input type="text" id="new-item-type-name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-new-item-type">Save Item Type</button>
            </div>
        </div>
    </div>
</div>

<!-- New Category Modal -->
<div class="modal fade" id="newCategoryModal" tabindex="-1" aria-labelledby="newCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newCategoryModalLabel">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-category-form">
                    <div class="form-group">
                        <label for="new-category-name" class="form-label">Category Name *</label>
                        <input type="text" id="new-category-name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-new-category">Save Category</button>
            </div>
        </div>
    </div>
</div>

<!-- New Department Modal -->
<div class="modal fade" id="newDepartmentModal" tabindex="-1" aria-labelledby="newDepartmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newDepartmentModalLabel">Add New Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-department-form">
                    <div class="form-group">
                        <label for="new-department-name" class="form-label">Department Name *</label>
                        <input type="text" id="new-department-name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-new-department">Save Department</button>
            </div>
        </div>
    </div>
</div>

<!-- New UOM Modal -->
<div class="modal fade" id="newUOMModal" tabindex="-1" aria-labelledby="newUOMModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newUOMModalLabel">Add New UOM</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-uom-form">
                    <div class="form-group">
                        <label for="new-uom-name" class="form-label">UOM Name *</label>
                        <input type="text" id="new-uom-name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-new-uom">Save UOM</button>
            </div>
        </div>
    </div>
</div>

<!-- New Machinery Modal -->
<div class="modal fade" id="newMachineryModal" tabindex="-1" aria-labelledby="newMachineryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newMachineryModalLabel">Add New Machinery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-machinery-form">
                    <div class="form-group">
                        <label for="new-machinery-name" class="form-label">Machinery Name *</label>
                        <input type="text" id="new-machinery-name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-new-machinery">Save Machinery</button>
            </div>
        </div>
    </div>
</div>

<!-- New Allergen Modal -->
<div class="modal fade" id="newAllergenModal" tabindex="-1" aria-labelledby="newAllergenModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newAllergenModalLabel">Add New Allergen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-allergen-form">
                    <div class="form-group">
                        <label for="new-allergen-name" class="form-label">Allergen Name *</label>
                        <input type="text" id="new-allergen-name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-new-allergen">Save Allergen</button>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    border: none;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
    padding: 1rem 1.35rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #4e73df;
}

.form-control, .form-select {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border: 1px solid #d1d3e2;
    border-radius: 0.35rem;
}

.form-control:focus, .form-select:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 0.35rem;
}

.btn-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-secondary {
    background-color: #858796;
    border-color: #858796;
}

/* Toggle Switch Styles */
.form-check-input {
    width: 2em;
    height: 1em;
    margin-top: 0.25em;
    vertical-align: top;
    background-color: #dee2e6;
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    border: 1px solid rgba(0, 0, 0, 0.25);
    appearance: none;
    print-color-adjust: exact;
}

.form-check-input:checked {
    background-color: #4e73df;
    border-color: #4e73df;
}

.form-check-input:focus {
    border-color: #bac8f3;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

.form-check-input:checked:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

.form-check-label {
    margin-left: 0.01rem;        
    font-weight: 500;
}

#status-label, #mto-label {
    color: #5a5c69;
    font-weight: 600;
}

.form-check-input:checked + .form-check-label #status-label {
    color: #1cc88a;
}

.form-check-input:not(:checked) + .form-check-label #status-label {
    color: #e74a3b;
}

.form-check-input:checked + .form-check-label #mto-label {
    color: #1cc88a;
}

.form-check-input:not(:checked) + .form-check-label #mto-label {
    color: #5a5c69;
}

/* Allergen Checkbox Styles */
.allergen-checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    padding: 5px;
    border: 1px solid #d1d3e2;
    border-radius: 0.35rem;
    background-color: #f8f9fa;
    min-height: 20px;
    align-items: flex-start;
    align-content: flex-start;
}

.form-check-inline {
    margin-right: 0;
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.allergen-checkbox {
    width: 1.2em !important;
    height: 1.2em !important;
    margin-top: 0;
    vertical-align: middle;
    background-color: #fff;
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    border: 1px solid #adb5bd;
    appearance: none;
    print-color-adjust: exact;
    border-radius: 0.25em;
}

.allergen-checkbox:checked {
    background-color: #4e73df;
    border-color: #4e73df;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e");
}

.allergen-checkbox:focus {
    border-color: #bac8f3;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

.allergen-checkbox:checked:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

.allergen-checkboxes .form-check-label {
    margin-left: 0.5rem;
    font-size: 0.875rem;
    color: #495057;
    cursor: pointer;
}

.allergen-checkboxes .form-check-label:hover {
    color: #4e73df;
}

.allergen-checkbox:checked + .form-check-label {
    color: #4e73df;
    font-weight: 500;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemTypeSelect = document.getElementById('item_type');
    const rawMaterialFields = document.getElementById('raw-material-fields');
    const finishedGoodFields = document.getElementById('finished-good-fields');
    const statusToggle = document.getElementById('is_active');
    const statusLabel = document.getElementById('status-label');
    const mtoToggle = document.getElementById('is_make_to_order');
    const mtoLabel = document.getElementById('mto-label');
    
    // Modal elements
    const newItemTypeModal = document.getElementById('newItemTypeModal');
    const newCategoryModal = document.getElementById('newCategoryModal');
    const newDepartmentModal = document.getElementById('newDepartmentModal');
    const newUOMModal = document.getElementById('newUOMModal');
    const newMachineryModal = document.getElementById('newMachineryModal');
    const newAllergenModal = document.getElementById('newAllergenModal');
    
    // Form elements
    const newItemTypeForm = document.getElementById('new-item-type-form');
    const newCategoryForm = document.getElementById('new-category-form');
    const newDepartmentForm = document.getElementById('new-department-form');
    const newUOMForm = document.getElementById('new-uom-form');
    const newMachineryForm = document.getElementById('new-machinery-form');
    const newAllergenForm = document.getElementById('new-allergen-form');
    
    // Input elements
    const newItemTypeName = document.getElementById('new-item-type-name');
    const newCategoryName = document.getElementById('new-category-name');
    const newDepartmentName = document.getElementById('new-department-name');
    const newUOMName = document.getElementById('new-uom-name');
    const newMachineryName = document.getElementById('new-machinery-name');
    const newAllergenName = document.getElementById('new-allergen-name');
    
    // Button elements
    const saveNewItemTypeBtn = document.getElementById('save-new-item-type');
    const saveNewCategoryBtn = document.getElementById('save-new-category');
    const saveNewDepartmentBtn = document.getElementById('save-new-department');
    const saveNewUOMBtn = document.getElementById('save-new-uom');
    const saveNewMachineryBtn = document.getElementById('save-new-machinery');
    const saveNewAllergenBtn = document.getElementById('save-new-allergen');

    // Status toggle handler
    statusToggle.addEventListener('change', function() {
        statusLabel.textContent = this.checked ? 'Active' : 'Inactive';
    });

    // Make to Order toggle handler
    mtoToggle.addEventListener('change', function() {
        mtoLabel.textContent = this.checked ? 'Yes' : 'No';
    });

    function toggleFields() {
        if (itemTypeSelect.value === 'Raw Material') {
            rawMaterialFields.style.display = 'block';
            finishedGoodFields.style.display = 'none';
            // Clear finished good fields
            document.getElementById('machinery_id').value = '';
            document.getElementById('kg_per_unit').value = '';
            document.getElementById('units_per_bag').value = '';
            document.getElementById('loss_percentage').value = '';
            mtoToggle.checked = false;
            mtoLabel.textContent = 'No';
        } else if (itemTypeSelect.value && itemTypeSelect.value !== 'new') {
            rawMaterialFields.style.display = 'none';
            finishedGoodFields.style.display = 'block';
            // Clear raw material fields
            document.getElementById('price_per_kg').value = '';
        }
    }

    // Set initial visibility on page load
    toggleFields();

    itemTypeSelect.addEventListener('change', function(){
        toggleFields();
    });

    // Handle saving new item type
    saveNewItemTypeBtn.addEventListener('click', function(){
        const typeName = newItemTypeName.value.trim();
        if (typeName){
            fetch('/item-type', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({type_name: typeName})
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                } else {
                    // Add new item type to the select dynamically 
                    const newOption = document.createElement('option');
                    newOption.value = typeName;
                    newOption.textContent = typeName;
                    itemTypeSelect.appendChild(newOption);
                    
                    // Select the newly created item type
                    itemTypeSelect.value = typeName;
                    
                    // Close modal and clear form
                    const modal = bootstrap.Modal.getInstance(newItemTypeModal);
                    modal.hide();
                    newItemTypeForm.reset();
                    
                    // Toggle fields based on new selection
                    toggleFields();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the item type');
            });
        } else {
            alert('Please enter a type name');
        }
    });

    // Handle saving new category
    saveNewCategoryBtn.addEventListener('click', function(){
        const categoryName = newCategoryName.value.trim();
        if (categoryName){
            fetch('/category', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({name: categoryName})
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                } else {
                    // Add new category to the select dynamically 
                    const categorySelect = document.getElementById('category_id');
                    const newOption = document.createElement('option');
                    newOption.value = result.id;
                    newOption.textContent = categoryName;
                    categorySelect.appendChild(newOption);
                    
                    // Select the newly created category
                    categorySelect.value = result.id;
                    
                    // Close modal and clear form
                    const modal = bootstrap.Modal.getInstance(newCategoryModal);
                    modal.hide();
                    newCategoryForm.reset();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the category');
            });
        } else {
            alert('Please enter a category name');
        }
    });

    // Handle saving new department
    saveNewDepartmentBtn.addEventListener('click', function(){
        const departmentName = newDepartmentName.value.trim();
        if (departmentName){
            fetch('/department', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({departmentName: departmentName})
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                } else {
                    // Add new department to the select dynamically 
                    const departmentSelect = document.getElementById('department_id');
                    const newOption = document.createElement('option');
                    newOption.value = result.id;
                    newOption.textContent = departmentName;
                    departmentSelect.appendChild(newOption);
                    
                    // Select the newly created department
                    departmentSelect.value = result.id;
                    
                    // Close modal and clear form
                    const modal = bootstrap.Modal.getInstance(newDepartmentModal);
                    modal.hide();
                    newDepartmentForm.reset();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the department');
            });
        } else {
            alert('Please enter a department name');
        }
    });

    // Handle saving new UOM
    saveNewUOMBtn.addEventListener('click', function(){
        const uomName = newUOMName.value.trim();
        if (uomName){
            fetch('/uom', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({UOMName: uomName})
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                } else {
                    // Add new UOM to the select dynamically 
                    const uomSelect = document.getElementById('uom_id');
                    const newOption = document.createElement('option');
                    newOption.value = result.id;
                    newOption.textContent = uomName;
                    uomSelect.appendChild(newOption);
                    
                    // Select the newly created UOM
                    uomSelect.value = result.id;
                    
                    // Close modal and clear form
                    const modal = bootstrap.Modal.getInstance(newUOMModal);
                    modal.hide();
                    newUOMForm.reset();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the UOM');
            });
        } else {
            alert('Please enter a UOM name');
        }
    });

    // Handle saving new machinery
    saveNewMachineryBtn.addEventListener('click', function(){
        const machineryName = newMachineryName.value.trim();
        if (machineryName){
            fetch('/machinery', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({machineryName: machineryName})
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                } else {
                    // Add new machinery to the select dynamically 
                    const machinerySelect = document.getElementById('machinery_id');
                    const newOption = document.createElement('option');
                    newOption.value = result.id;
                    newOption.textContent = machineryName;
                    machinerySelect.appendChild(newOption);
                    
                    // Select the newly created machinery
                    machinerySelect.value = result.id;
                    
                    // Close modal and clear form
                    const modal = bootstrap.Modal.getInstance(newMachineryModal);
                    modal.hide();
                    newMachineryForm.reset();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the machinery');
            });
        } else {
            alert('Please enter a machinery name');
        }
    });

    // Handle saving new allergen
    saveNewAllergenBtn.addEventListener('click', function(){
        const allergenName = newAllergenName.value.trim();
        if (allergenName){
            fetch('/allergen', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({name: allergenName})
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                } else {
                    // Add new checkbox to allergen section
                    const allergenContainer = document.querySelector('.allergen-checkboxes');
                    const newCheckboxDiv = document.createElement('div');
                    newCheckboxDiv.className = 'form-check form-check-inline';
                    newCheckboxDiv.innerHTML = `
                        <input class="form-check-input allergen-checkbox" type="checkbox" 
                               id="allergen_${result.id}" 
                               name="allergen_ids" 
                               value="${result.id}"
                               checked>
                        <label class="form-check-label" for="allergen_${result.id}">
                            ${allergenName}
                        </label>
                    `;
                    allergenContainer.appendChild(newCheckboxDiv);
                    
                    // Close modal and clear form
                    const modal = bootstrap.Modal.getInstance(newAllergenModal);
                    modal.hide();
                    newAllergenForm.reset();
                    alert('Allergen added successfully!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the allergen');
            });
        } else {
            alert('Please enter an allergen name');
        }
    });

    // Clear forms when modals are closed
    [newItemTypeModal, newCategoryModal, newDepartmentModal, newUOMModal, newMachineryModal, newAllergenModal].forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function () {
            const formId = this.querySelector('form').id;
            document.getElementById(formId).reset();
        });
    });

    document.getElementById('item-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        
        // Handle regular form fields
        formData.forEach((value, key) => {
            if (key === 'allergen_ids') {
                if (!data[key]) data[key] = [];
                data[key].push(value);
            } else {
                data[key] = value === '' ? null : value;
            }
        });

        // Handle checkbox values for toggles
        data.is_active = statusToggle.checked;
        data.is_make_to_order = mtoToggle.checked;

        // Handle allergen checkboxes manually since FormData may not capture unchecked boxes correctly
        const allergenCheckboxes = document.querySelectorAll('.allergen-checkbox:checked');
        data.allergen_ids = Array.from(allergenCheckboxes).map(cb => cb.value);

        fetch('/item-master', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                alert(result.message);
                window.location.href = '/item-master';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the item');
        });
    });
});
</script>
{% endblock %}