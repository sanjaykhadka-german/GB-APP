{% extends 'index.html' %}

{% block content %}
<style>
    .allergen-section {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
    }    .allergen-container {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .allergen-label {
        flex: 0 0 auto;
        padding-top: 1rem;
        font-weight: 500;
        color: #4e73df;
        min-width: 80px;
    }

    .allergen-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .allergen-checkbox-wrapper {
        display: inline-flex;
        align-items: center;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        transition: all 0.2s ease-in-out;
    }

    .allergen-checkbox-wrapper:hover {
        border-color: #adb5bd;
        background-color: #f8f9fa;
    }

    .allergen-checkbox-wrapper .form-check-input {
        margin-right: 0.35rem;
        margin-top: 0;
    }

    .allergen-checkbox-wrapper .form-check-label {
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.4;
        user-select: none;
    }

    .allergen-checkbox-wrapper input[type="checkbox"]:checked ~ .form-check-label {
        font-weight: 500;
    }

    .allergen-add-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.4;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
    }
</style>

<div class="container-fluid px-4">
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">Create New Item</h4>
        </div>
        <div class="card-body">
            <form id="item-form">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="item_code" class="form-label">Item Code *</label>
                            <input type="text" id="item_code" name="item_code" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="description" class="form-label">Description *</label>
                            <input type="text" id="description" name="description" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="item_type" class="form-label">Item Type *</label>
                            <div class="input-group">
                                <select id="item_type" name="item_type" class="form-select" required>
                                    <option value="">Select Item Type</option>
                                    {% for item_type in item_types %}
                                    <option value="{{ item_type.type_name }}">{{ item_type.type_name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newItemTypeModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="category_id" class="form-label">Category</label>
                            <div class="input-group">
                                <select id="category_id" name="category_id" class="form-select">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newCategoryModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="department_id" class="form-label">Department</label>
                            <div class="input-group">
                                <select id="department_id" name="department_id" class="form-select">
                                    <option value="">Select Department</option>
                                    {% for department in departments %}
                                    <option value="{{ department.department_id }}">{{ department.departmentName }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newDepartmentModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="uom_id" class="form-label">UOM</label>
                            <div class="input-group">
                                <select id="uom_id" name="uom_id" class="form-select">
                                    <option value="">Select UOM</option>
                                    {% for uom in uoms %}
                                    <option value="{{ uom.UOMID }}">{{ uom.UOMName }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newUOMModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="min_level" class="form-label">Min Level</label>
                            <input type="number" id="min_level" name="min_level" class="form-control" step="1" min="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="max_level" class="form-label">Max Level</label>
                            <input type="number" id="max_level" name="max_level" class="form-control" step="1" min="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                <label class="form-check-label" for="is_active">
                                    <span id="status-label">Active</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for Adding New Item Type -->
                <div class="modal fade" id="newItemTypeModal" tabindex="-1" aria-labelledby="newItemTypeModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="newItemTypeModalLabel">Add New Item Type</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="new-item-type-form">
                                    <div class="form-group">
                                        <label for="new-item-type-name" class="form-label">Type Name</label>
                                        <input type="text" id="new-item-type-name" class="form-control" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-new-item-type">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for Adding New Category -->
                <div class="modal fade" id="newCategoryModal" tabindex="-1" aria-labelledby="newCategoryModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="newCategoryModalLabel">Add New Category</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="new-category-form">
                                    <div class="form-group">
                                        <label for="new-category-name" class="form-label">Category Name</label>
                                        <input type="text" id="new-category-name" class="form-control" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-new-category">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for Adding New Department -->
                <div class="modal fade" id="newDepartmentModal" tabindex="-1" aria-labelledby="newDepartmentModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="newDepartmentModalLabel">Add New Department</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="new-department-form">
                                    <div class="form-group">
                                        <label for="new-department-name" class="form-label">Department Name</label>
                                        <input type="text" id="new-department-name" class="form-control" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-new-department">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for Adding New UOM -->
                <div class="modal fade" id="newUOMModal" tabindex="-1" aria-labelledby="newUOMModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="newUOMModalLabel">Add New UOM</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="new-uom-form">
                                    <div class="form-group">
                                        <label for="new-uom-name" class="form-label">UOM Name</label>
                                        <input type="text" id="new-uom-name" class="form-control" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-new-uom">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for Adding New Machinery -->
                <div class="modal fade" id="newMachineryModal" tabindex="-1" aria-labelledby="newMachineryModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="newMachineryModalLabel">Add New Machinery</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="new-machinery-form">
                                    <div class="form-group">
                                        <label for="new-machinery-name" class="form-label">Machinery Name</label>
                                        <input type="text" id="new-machinery-name" class="form-control" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-new-machinery">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw Material Specific Fields -->
                <div id="raw-material-fields" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="price_per_kg" class="form-label">Price per KG</label>
                                <input type="number" id="price_per_kg" name="price_per_kg" class="form-control" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finished Good Specific Fields -->
                <div id="finished-good-fields" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="machinery_id" class="form-label">Machinery</label>
                                <div class="input-group">
                                    <select id="machinery_id" name="machinery_id" class="form-select">
                                        <option value="">Select Machinery</option>
                                        {% for machine in machinery %}
                                        <option value="{{ machine.machineID }}">{{ machine.machineryName }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newMachineryModal">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="kg_per_unit" class="form-label">KG per Unit</label>
                                <input type="number" id="kg_per_unit" name="kg_per_unit" class="form-control" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="units_per_bag" class="form-label">Units per Bag</label>
                                <input type="number" id="units_per_bag" name="units_per_bag" class="form-control" step="1" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="loss_percentage" class="form-label">Loss Percentage</label>
                                <input type="number" id="loss_percentage" name="loss_percentage" class="form-control" step="0.01" min="0" max="100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Make to Order</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="is_make_to_order" name="is_make_to_order">
                                    <label class="form-check-label" for="is_make_to_order">
                                        <span id="mto-label">No</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>                <!-- Allergens -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="allergen-container">
                            <label class="allergen-label">Allergens</label>
                            <div class="allergen-section">
                                <div class="allergen-checkboxes">
                                    {% for allergen in allergens %}
                                    <div class="allergen-checkbox-wrapper">
                                        <input class="form-check-input allergen-checkbox" type="checkbox" 
                                               id="allergen_{{ allergen.allergens_id }}" 
                                               name="allergen_ids" 
                                               value="{{ allergen.allergens_id }}">
                                        <label class="form-check-label" for="allergen_{{ allergen.allergens_id }}">
                                            {{ allergen.name }}
                                        </label>
                                    </div>                                    {% endfor %}
                                    <button type="button" class="btn btn-outline-secondary allergen-add-btn" data-bs-toggle="modal" data-bs-target="#newAllergenModal">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for Adding New Allergen -->
                <div class="modal fade" id="newAllergenModal" tabindex="-1" aria-labelledby="newAllergenModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="newAllergenModalLabel">Add New Allergen</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="new-allergen-form">
                                    <div class="form-group">
                                        <label for="new-allergen-name" class="form-label">Allergen Name</label>
                                        <input type="text" id="new-allergen-name" class="form-control" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="save-new-allergen">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Item
                        </button>
                        <a href="/item-master" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    border: none;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
    padding: 1rem 1.35rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #4e73df;
}

.form-control, .form-select {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border: 1px solid #d1d3e2;
    border-radius: 0.35rem;
}

.form-control:focus, .form-select:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 0.35rem;
}

.btn-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-secondary {
    background-color: #858796;
    border-color: #858796;
}

/* Toggle Switch Styles */
.form-check-input {
    width: 2em;
    height: 1em;
    margin-top: 0.25em;
    vertical-align: top;
    background-color: #dee2e6;
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    border: 1px solid rgba(0, 0, 0, 0.25);
    appearance: none;
    print-color-adjust: exact;
}

.form-check-input:checked {
    background-color: #4e73df;
    border-color: #4e73df;
}

.form-check-input:focus {
    border-color: #bac8f3;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

.form-check-input:checked:focus {
    border-color: #bac8f3;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

.form-check-label {
    margin-left: 0.01rem;        
    font-weight: 500;
}

#status-label, #mto-label {
    color: #5a5c69;
    font-weight: 600;
}

.form-check-input:checked + .form-check-label #status-label {
    color: #1cc88a;
}

.form-check-input:not(:checked) + .form-check-label #status-label {
    color: #e74a3b;
}

.form-check-input:checked + .form-check-label #mto-label {
    color: #1cc88a;
}

.form-check-input:not(:checked) + .form-check-label #mto-label {
    color: #5a5c69;
}


</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemTypeSelect = document.getElementById('item_type');
    const rawMaterialFields = document.getElementById('raw-material-fields');
    const finishedGoodFields = document.getElementById('finished-good-fields');
    const statusToggle = document.getElementById('is_active');
    const statusLabel = document.getElementById('status-label');
    const mtoToggle = document.getElementById('is_make_to_order');
    const mtoLabel = document.getElementById('mto-label');

    // Status toggle handler
    statusToggle.addEventListener('change', function() {
        statusLabel.textContent = this.checked ? 'Active' : 'Inactive';
    });

    // Make to Order toggle handler
    mtoToggle.addEventListener('change', function() {
        mtoLabel.textContent = this.checked ? 'Yes' : 'No';
    });

    function toggleFields() {
        if (itemTypeSelect.value === 'Raw Material') {
            rawMaterialFields.style.display = 'block';
            finishedGoodFields.style.display = 'none';
            // Clear finished good fields
            document.getElementById('machinery_id').value = '';
            document.getElementById('kg_per_unit').value = '';
            document.getElementById('units_per_bag').value = '';
            document.getElementById('loss_percentage').value = '';
            mtoToggle.checked = false;
            mtoLabel.textContent = 'No';
        } else if (itemTypeSelect.value === 'Finished Good' || itemTypeSelect.value === 'WIPF' || itemTypeSelect.value === 'WIP') {
            rawMaterialFields.style.display = 'none';
            finishedGoodFields.style.display = 'block';
            // Clear raw material fields
            document.getElementById('price_per_kg').value = '';
        } else {
            rawMaterialFields.style.display = 'none';
            finishedGoodFields.style.display = 'none';
        }
    }

    itemTypeSelect.addEventListener('change', toggleFields);
    
    // Initialize toggle states
    toggleFields();

    document.getElementById('item-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        
        // Handle regular form fields
        formData.forEach((value, key) => {
            if (key === 'allergen_ids') {
                if (!data[key]) data[key] = [];
                data[key].push(value);
            } else {
                data[key] = value === '' ? null : value;
            }
        });

        // Handle checkbox values for toggles
        data.is_active = statusToggle.checked;
        data.is_make_to_order = mtoToggle.checked;

        // Handle allergen checkboxes manually since FormData may not capture unchecked boxes correctly
        const allergenCheckboxes = document.querySelectorAll('.allergen-checkbox:checked');
        data.allergen_ids = Array.from(allergenCheckboxes).map(cb => cb.value);

        fetch('/item-master', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                alert(result.message);
                window.location.href = '/item-master';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the item');
        });
    });

    // Category modal functionality
    document.getElementById('save-new-category').addEventListener('click', function() {
        const categoryName = document.getElementById('new-category-name').value.trim();
        if (!categoryName) {
            alert('Please enter a category name');
            return;
        }

        fetch('/category', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({name: categoryName})
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                // Add new option to select
                const select = document.getElementById('category_id');
                const option = document.createElement('option');
                option.value = result.id;
                option.textContent = categoryName;
                select.appendChild(option);
                select.value = result.id;
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('newCategoryModal')).hide();
                document.getElementById('new-category-form').reset();
                alert('Category added successfully!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the category');
        });
    });

    // Department modal functionality
    document.getElementById('save-new-department').addEventListener('click', function() {
        const departmentName = document.getElementById('new-department-name').value.trim();
        if (!departmentName) {
            alert('Please enter a department name');
            return;
        }

        fetch('/department', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({departmentName: departmentName})
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                // Add new option to select
                const select = document.getElementById('department_id');
                const option = document.createElement('option');
                option.value = result.id;
                option.textContent = departmentName;
                select.appendChild(option);
                select.value = result.id;
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('newDepartmentModal')).hide();
                document.getElementById('new-department-form').reset();
                alert('Department added successfully!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the department');
        });
    });

    // UOM modal functionality
    document.getElementById('save-new-uom').addEventListener('click', function() {
        const uomName = document.getElementById('new-uom-name').value.trim();
        if (!uomName) {
            alert('Please enter a UOM name');
            return;
        }

        fetch('/uom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({UOMName: uomName})
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                // Add new option to select
                const select = document.getElementById('uom_id');
                const option = document.createElement('option');
                option.value = result.id;
                option.textContent = uomName;
                select.appendChild(option);
                select.value = result.id;
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('newUOMModal')).hide();
                document.getElementById('new-uom-form').reset();
                alert('UOM added successfully!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the UOM');
        });
    });

    // Machinery modal functionality
    document.getElementById('save-new-machinery').addEventListener('click', function() {
        const machineryName = document.getElementById('new-machinery-name').value.trim();
        if (!machineryName) {
            alert('Please enter a machinery name');
            return;
        }

        fetch('/machinery', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({machineryName: machineryName})
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                // Add new option to select
                const select = document.getElementById('machinery_id');
                const option = document.createElement('option');
                option.value = result.id;
                option.textContent = machineryName;
                select.appendChild(option);
                select.value = result.id;
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('newMachineryModal')).hide();
                document.getElementById('new-machinery-form').reset();
                alert('Machinery added successfully!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the machinery');
        });
    });

    // Allergen modal functionality
    document.getElementById('save-new-allergen').addEventListener('click', function() {
        const allergenName = document.getElementById('new-allergen-name').value.trim();
        if (!allergenName) {
            alert('Please enter an allergen name');
            return;
        }

        fetch('/allergen', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({name: allergenName})
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                // Add new checkbox to allergen section                const allergenContainer = document.querySelector('.allergen-checkboxes');
                const addButton = allergenContainer.querySelector('.allergen-add-btn');
                const newCheckboxDiv = document.createElement('div');
                newCheckboxDiv.className = 'allergen-checkbox-wrapper';
                newCheckboxDiv.innerHTML = `
                    <input class="form-check-input allergen-checkbox" type="checkbox" 
                           id="allergen_${result.id}" 
                           name="allergen_ids" 
                           value="${result.id}"
                           checked>
                    <label class="form-check-label" for="allergen_${result.id}">
                        ${allergenName}
                    </label>
                `;
                allergenContainer.insertBefore(newCheckboxDiv, addButton);
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('newAllergenModal')).hide();
                document.getElementById('new-allergen-form').reset();
                alert('Allergen added successfully!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the allergen');
        });
    });

    // Item Type modal functionality
    document.getElementById('save-new-item-type').addEventListener('click', function() {
        const itemTypeName = document.getElementById('new-item-type-name').value.trim();
        if (!itemTypeName) {
            alert('Please enter an item type name');
            return;
        }

        fetch('/item-type', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({type_name: itemTypeName})
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                // Add new option to select
                const select = document.getElementById('item_type');
                const option = document.createElement('option');
                option.value = itemTypeName;
                option.textContent = itemTypeName;
                select.appendChild(option);
                select.value = itemTypeName;
                
                // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('newItemTypeModal')).hide();
                document.getElementById('new-item-type-form').reset();
                
                // Trigger field toggle to show appropriate fields
                toggleFields();
                
                alert('Item type added successfully!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the item type');
        });
    });
});
</script>
{% endblock %}