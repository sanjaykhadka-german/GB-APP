{% extends 'index.html' %}

{% block content %}
<div class="container">
    <h2>Add Ingredient to Stock Management</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <form method="POST" action="{{ url_for('ingredients.ingredients_create') }}" id="ingredientForm">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="week_commencing">Week Commencing</label>
                    <input type="date" class="form-control" id="week_commencing" name="week_commencing" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="stocktake_type">Stocktake Type</label>
                    <select class="form-control" id="stocktake_type" name="stocktake_type" required>
                        <option value="">Select Stocktake Type</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="annual">Annual</option>
                        <option value="obsolete">Obsolete</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="user">User</label>
            <input type="text" class="form-control" id="user" name="user" required placeholder="Enter username">
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="item_code_select">Item Code</label>
                    <select class="form-control" id="item_code_select" name="item_code" required onchange="updateFormFromSelection()">
                        <option value="">Select Item Code</option>
                        {% for item in existing_items %}
                            {% if item.item_type == 'RM' %}
                            <option value="{{ item.item_code }}" 
                                    data-description="{{ item.description or '' }}"
                                    data-department="{{ item.department.department_name if item.department else '' }}"
                                    data-uom="{{ item.uom.UOM if item.uom else '' }}"
                                    data-min-level="{{ item.min_level or 0 }}"
                                    data-max-level="{{ item.max_level or 0 }}"
                                    data-price-kg="{{ item.price_per_kg or 0 }}"
                                    data-active="{{ 'true' if item.is_active else 'false' }}">
                                {{ item.item_code }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text" class="form-control" id="description" name="description" readonly>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="uom">UOM</label>
                    <input type="text" class="form-control" id="uom" name="uom" readonly>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="department">Department</label>
                    <input type="text" class="form-control" id="department" name="department" readonly>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="current_stock">Current Stock</label>
                    <input type="number" step="0.01" class="form-control" id="current_stock" name="current_stock" value="0" required onchange="calculateStockValue()">
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="min_level">Min Level</label>
                    <input type="number" step="0.01" class="form-control" id="min_level" name="min_level" value="0" readonly>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="max_level">Max Level</label>
                    <input type="number" step="0.01" class="form-control" id="max_level" name="max_level" value="0" readonly>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="price_uom">$/UOM</label>
                    <input type="number" step="0.01" class="form-control" id="price_uom" name="price_uom" value="0" onchange="calculateStockValue()">
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="price_kg">$/KG</label>
                    <input type="number" step="0.01" class="form-control" id="price_kg" name="price_kg" value="0" readonly>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="stock_value">Stock Value</label>
                    <input type="number" step="0.01" class="form-control" id="stock_value" name="stock_value" value="0" readonly>
                    <small class="form-text text-muted">Auto-calculated: Current Stock Ã— $/UOM</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Additional notes"></textarea>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary" id="submitButton">Add to Stock Management</button>
        <a href="{{ url_for('ingredients.ingredients_list') }}" class="btn btn-secondary">Cancel</a>
    </form>
</div>



<style>
    .form-text {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }
    
    .readonly-field {
        background-color: #f8f9fa;
    }
</style>

<script>
// Set default week commencing to current Monday
function setDefaultWeekCommencing() {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const daysToMonday = dayOfWeek === 0 ? -6 : -dayOfWeek + 1; // Adjust to Monday
    const monday = new Date(today);
    monday.setDate(today.getDate() + daysToMonday);
    
    const year = monday.getFullYear();
    const month = String(monday.getMonth() + 1).padStart(2, '0');
    const day = String(monday.getDate()).padStart(2, '0');
    document.getElementById('week_commencing').value = `${year}-${month}-${day}`;
}

// Calculate stock value
function calculateStockValue() {
    const currentStock = parseFloat(document.getElementById('current_stock').value) || 0;
    const priceUom = parseFloat(document.getElementById('price_uom').value) || 0;
    const stockValue = currentStock * priceUom;
    document.getElementById('stock_value').value = stockValue.toFixed(2);
}

// Form validation
document.getElementById('ingredientForm').addEventListener('submit', function(e) {
    var itemCode = document.getElementById('item_code_select').value.trim();
    var weekCommencing = document.getElementById('week_commencing').value.trim();
    var stocktakeType = document.getElementById('stocktake_type').value.trim();
    var user = document.getElementById('user').value.trim();
    var currentStock = parseFloat(document.getElementById('current_stock').value);
    var priceUom = parseFloat(document.getElementById('price_uom').value);
    
    if (!itemCode) {
        e.preventDefault();
        alert('Please select an item code.');
        return;
    }
    
    if (!weekCommencing) {
        e.preventDefault();
        alert('Please select week commencing date.');
        return;
    }
    
    if (!stocktakeType) {
        e.preventDefault();
        alert('Please select stocktake type.');
        return;
    }
    
    if (!user) {
        e.preventDefault();
        alert('Please enter user name.');
        return;
    }
    
    if (currentStock < 0 || priceUom < 0) {
        e.preventDefault();
        alert('Stock levels and prices must be non-negative numbers.');
        return;
    }
});

// Update form fields when item is selected from dropdown
function updateFormFromSelection() {
    const itemSelect = document.getElementById('item_code_select');
    const selectedOption = itemSelect.options[itemSelect.selectedIndex];
    
    if (selectedOption && selectedOption.value !== "") {
        // Auto-populate read-only fields from selected item
        document.getElementById('description').value = selectedOption.getAttribute('data-description') || '';
        document.getElementById('uom').value = selectedOption.getAttribute('data-uom') || '';
        document.getElementById('department').value = selectedOption.getAttribute('data-department') || '';
        document.getElementById('min_level').value = selectedOption.getAttribute('data-min-level') || '0';
        document.getElementById('max_level').value = selectedOption.getAttribute('data-max-level') || '0';
        document.getElementById('price_kg').value = selectedOption.getAttribute('data-price-kg') || '0';
        
        // Focus on current stock field for user input
        document.getElementById('current_stock').focus();
        
        // Calculate stock value when item is selected
        calculateStockValue();
    } else {
        // Clear fields when no item is selected
        document.getElementById('description').value = '';
        document.getElementById('uom').value = '';
        document.getElementById('department').value = '';
        document.getElementById('min_level').value = '0';
        document.getElementById('max_level').value = '0';
        document.getElementById('price_kg').value = '0';
        document.getElementById('current_stock').value = '0';
        document.getElementById('price_uom').value = '0';
        document.getElementById('stock_value').value = '0';
        document.getElementById('notes').value = '';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Set default week commencing
    setDefaultWeekCommencing();
    
    // Auto-dismiss alerts after 5 seconds
    setTimeout(function() {
        var alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            if (alert.classList.contains('alert-dismissible')) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        });
    }, 5000);
});
</script>
{% endblock %} 