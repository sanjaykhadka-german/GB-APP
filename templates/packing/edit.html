{% extends 'index.html' %}

{% block content %}
<div class="container">
    <h2>Edit Packing Entry</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <form method="POST" action="{{ url_for('packing.packing_edit', id=packing.id) }}" id="packingForm">
                <div class="form-group">
            <label for="week_commencing">Week Commencing</label>
            <input type="date" class="form-control" id="week_commencing" name="week_commencing" value="{{ packing.week_commencing }}" readonly required>
            </div>
                <div class="form-group">
            <label for="packing_date">Packing Date</label>
            <input type="text" class="form-control" id="packing_date" name="packing_date" value="{{ packing.packing_date }}" required placeholder="Select a date">
        </div>
                <div class="form-group">
            <label for="product_code">Product Code</label>
            <select class="form-control" id="product_code" name="product_code" required onchange="updateDescription(); checkDuplicate()">
                <option value="">Select Product Code</option>
                {% for product in products %}
                    <option value="{{ product.item_code }}" data-description="{{ product.description }}" data-item-id="{{ product.id }}" {% if product.id == packing.item_id %}selected{% endif %}>{{ product.item_code }} - {{ product.description }}</option>
                {% endfor %}
            </select>
            </div>
                <div class="form-group">
            <label for="special_order_kg">Special Order KG</label>
            <input type="number" step="0.01" class="form-control" id="special_order_kg" name="special_order_kg" value="{{ packing.special_order_kg }}">
        </div>
                <div class="form-group">
            <label for="calculation_factor">Calculation Factor</label>
            <input type="number" step="0.01" class="form-control" id="calculation_factor" name="calculation_factor" value="{{ packing.calculation_factor }}">
            <small class="form-text text-muted">Leave as 0.0 to use the calculation factor from Item Master</small>
        </div>

        <!-- ItemMaster Info Display -->
        <div class="item-master-info" id="itemMasterInfo" style="display: none;">
            <div class="card mt-3 mb-3">
                <div class="card-header">
                    <h6 class="mb-0 text-primary">Item Master Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Avg Weight/Unit:</strong>
                            <span id="displayAvgWeight">-</span> kg
            </div>
                        <div class="col-md-3">
                            <strong>Min Level:</strong>
                            <span id="displayMinLevel">-</span> units
                </div>
                        <div class="col-md-3">
                            <strong>Max Level:</strong>
                            <span id="displayMaxLevel">-</span> units
        </div>
                        <div class="col-md-3">
                            <strong>Calc Factor:</strong>
                            <span id="displayCalcFactor">-</span>
                </div>
            </div>
                </div>
            </div>
        </div>

                <div class="form-group">
            <label for="machinery">Machinery</label>
            <select class="form-control" id="machinery" name="machinery" onchange="checkDuplicate()">
                        <option value="">Select Machinery</option>
                {% for machine in machinery %}
                    <option value="{{ machine.machineID }}" {% if machine.machineID == packing.machinery_id %}selected{% endif %}>{{ machine.machineryName }}</option>
            {% endfor %}
                    </select>
                </div>
                <div class="form-group">
            <label for="priority">Priority</label>
            <input type="number" class="form-control" id="priority" name="priority" value="{{ packing.priority }}">
        </div>

        <!-- Allergens Section -->
        <div class="allergen-container">
            <label class="allergen-label">Allergens</label>
            <div class="allergen-section">
                <div class="allergen-checkboxes">
                    {% for allergen in allergens %}
                    <div class="allergen-checkbox-wrapper">
                        <input class="form-check-input allergen-checkbox" type="checkbox" 
                               id="allergen_{{ allergen.allergens_id }}" 
                               name="allergen_ids[]" 
                               value="{{ allergen.allergens_id }}"
                               {% if allergen in packing.item.allergens %}checked{% endif %}
                               disabled>
                        <label class="form-check-label" for="allergen_{{ allergen.allergens_id }}">
                            {{ allergen.name }}
                        </label>
    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary" id="submitButton">Update</button>
        <a href="{{ url_for('packing.packing_list') }}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<!-- Include Flatpickr CSS and JS from CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    .allergen-section {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
        margin-bottom: 1rem;
    }
    
    .allergen-container {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .allergen-label {
        flex: 0 0 auto;
        padding-top: 1rem;
        font-weight: 500;
        color: #4e73df;
        min-width: 80px;
    }

    .allergen-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .allergen-checkbox-wrapper {
        display: inline-flex;
        align-items: center;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        transition: all 0.2s ease-in-out;
    }

    .allergen-checkbox-wrapper:hover {
        border-color: #adb5bd;
        background-color: #f8f9fa;
    }

    .allergen-checkbox-wrapper .form-check-input {
        margin-right: 0.35rem;
        margin-top: 0;
    }

    .allergen-checkbox-wrapper .form-check-label {
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.4;
        user-select: none;
    }

    .allergen-checkbox-wrapper input[type="checkbox"]:checked ~ .form-check-label {
        font-weight: 500;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Flatpickr for date picker with onChange callback
    flatpickr("#packing_date", {
        dateFormat: "Y-m-d",
        defaultDate: "{{ packing.packing_date }}",
        onChange: function(selectedDates, dateStr, instance) {
            // Automatically update week commencing when packing date changes
            updateWeekCommencing();
            // Also check for duplicates when date changes
            checkDuplicate();
        }
    });

    // Show item master info on load if product is selected
    const productSelect = document.getElementById('product_code');
    if (productSelect.value) {
        updateDescription();
    }
});

function updateWeekCommencing() {
    const packingDateElement = document.getElementById('packing_date');
    const weekCommencingElement = document.getElementById('week_commencing');
    
    const packingDate = packingDateElement.value;
    
    if (packingDate) {
        const date = new Date(packingDate);
        const day = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
        const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
        const monday = new Date(date.setDate(diff));
        weekCommencingElement.value = monday.toISOString().split('T')[0];
    }
}

function updateDescription() {
    const productSelect = document.getElementById('product_code');
    const selectedOption = productSelect.options[productSelect.selectedIndex];
    const productCode = productSelect.value;
    
    if (productCode) {
        // Show the item master info section
        document.getElementById('itemMasterInfo').style.display = 'block';
        
        // Fetch item master info including allergens
        fetch(`/item_master/${selectedOption.getAttribute('data-item-id')}/info`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update item master info display
                    document.getElementById('displayAvgWeight').textContent = data.avg_weight_per_unit.toFixed(4);
                    document.getElementById('displayMinLevel').textContent = data.min_level.toFixed(0);
                    document.getElementById('displayMaxLevel').textContent = data.max_level.toFixed(0);
                    document.getElementById('displayCalcFactor').textContent = data.calculation_factor.toFixed(4);
                    
                    // Update allergen checkboxes
                    document.querySelectorAll('.allergen-checkbox').forEach(checkbox => {
                        checkbox.checked = data.allergen_ids.includes(parseInt(checkbox.value));
                    });
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    } else {
        // Hide the item master info section if no product selected
        document.getElementById('itemMasterInfo').style.display = 'none';
        
        // Clear allergen checkboxes
        document.querySelectorAll('.allergen-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    }
}

function checkDuplicate() {
    const product_code = document.getElementById('product_code').value;
    const packing_date = document.getElementById('packing_date').value;
    const machinery = document.getElementById('machinery').value;
    const week_commencing = document.getElementById('week_commencing').value;
    
    if (product_code && packing_date && week_commencing) {
        const params = new URLSearchParams({
            product_code: product_code,
            packing_date: packing_date,
            machinery: machinery || '',
            week_commencing: week_commencing
        });
        
        fetch(`/packing/check_duplicate?${params}`)
            .then(response => response.json())
            .then(data => {
                const submitButton = document.getElementById('submitButton');
                if (data.exists) {
                    submitButton.disabled = true;
                    alert(`A packing entry already exists for ${product_code} on ${packing_date}. Please choose a different date or product.`);
                } else {
                    submitButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error checking for duplicates:', error);
            });
    }
}
</script>
{% endblock %}