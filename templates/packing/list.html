{% extends 'index.html' %}

{% block content %}
<div style="width: 100%">
    <!-- Packing Search Section -->
    <section id="search">
        <h2>Packing Search</h2>
        <form id="searchForm">
            <div class="form-group">
                <label for="search_fg_code">Product Code:</label>
                <input type="text" id="search_fg_code" name="fg_code" value="{{ search_fg_code | default('') }}" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="search_description">Description:</label>
                <input type="text" id="search_description" name="description" value="{{ search_description | default('') }}">
            </div>
            <div class="form-group">
                <label for="search_packing_date_start">Packing Date (From):</label>
                <input type="date" id="search_packing_date_start" name="packing_date_start" value="{{ search_packing_date_start | default('') }}">
            </div>
            <div class="form-group">
                <label for="search_packing_date_end">Packing Date (To):</label>
                <input type="date" id="search_packing_date_end" name="packing_date_end" value="{{ search_packing_date_end | default('') }}">
            </div>
            <div class="form-group">
                <label for="search_week_commencing">Week Commencing:</label>
                <input type="date" id="search_week_commencing" name="week_commencing" value="{{ search_week_commencing | default('') }}">
            </div>
            <div class="form-group">
                <label for="search_machinery">Machinery:</label>
                <select id="search_machinery" name="machinery">
                    <option value="">All Machinery</option>
                    <!-- Options will be populated dynamically via JavaScript -->
                </select>
            </div>
            <button type="button" onclick="fetchPackings()">Search</button>
            <button type="button" class="btn btn-primary" onclick="exportToExcel()">Export to Excel</button>
            <div id="fg_code_suggestions" class="suggestion-list"></div>
        </form>
    </section>

    <!-- Column Visibility Toggle Section -->
    <section id="column-toggle">
        <h3>Column Visibility</h3>
        <div class="column-toggle">
            <div class="toggle-row">
                <label><input type="checkbox" checked data-col-index="2" onchange="toggleColumn(2)"> Week Commencing</label>
                <label><input type="checkbox" checked data-col-index="3" onchange="toggleColumn(3)"> Packing Date</label>
                <label><input type="checkbox" checked data-col-index="6" onchange="toggleColumn(6)"> Special Order KG</label>
                <label><input type="checkbox" checked data-col-index="7" onchange="toggleColumn(7)"> Special Order Unit</label>
                <label><input type="checkbox" checked data-col-index="10" onchange="toggleColumn(10)"> Avg Weight per Unit</label>
            </div>
            <div class="toggle-row">
                <label><input type="checkbox" data-col-index="11" onchange="toggleColumn(11)"> SOH Req KG/Week</label>
                <label><input type="checkbox" checked data-col-index="12" onchange="toggleColumn(12)"> SOH Req Units/Week</label>
                <label><input type="checkbox" data-col-index="13" onchange="toggleColumn(13)"> SOH KG</label>
                <label><input type="checkbox" data-col-index="14" onchange="toggleColumn(14)"> SOH Units</label>
                <label><input type="checkbox" checked data-col-index="15" onchange="toggleColumn(15)"> Machinery</label>
            </div>
            <div class="toggle-row">
                <label><input type="checkbox" data-col-index="16" onchange="toggleColumn(16)"> Total Stock KG</label>
                <label><input type="checkbox" data-col-index="17" onchange="toggleColumn(17)"> Total Stock Units</label>
                <label><input type="checkbox" checked data-col-index="18" onchange="toggleColumn(18)"> Calculation Factor</label>
                <label><input type="checkbox" checked data-col-index="19" onchange="toggleColumn(19)"> Priority</label>
            </div>
            <div class="toggle-actions">
                <button type="button" class="btn btn-sm btn-secondary" onclick="showEssentialColumns()">Show Essential Only</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="showAllColumns()">Show All</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="resetToDefault()">Reset to Default</button>
            </div>
        </div>
    </section>

    <!-- Packing List Section -->
    <section id="list">
        <h2>Packing List</h2>
        <a href="{{ url_for('packing.packing_create') }}" class="btn btn-primary my-3">Create New Packing</a>
        <a href="#" class="btn btn-primary my-3" data-bs-toggle="modal" data-bs-target="#bulkEditModal">Bulk Edit</a>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <div id="resultSection" class="table-container">
            <table class="table table-bordered" id="packingListTable">
                <thead>
                    <tr>
                        <th data-col-index="1"><input type="checkbox" id="selectAll"></th>
                        <th data-column="week_commencing" data-col-index="2">Week Commencing <span class="sort-arrow"></span></th>
                        <th data-column="packing_date" data-col-index="3">Packing Date <span class="sort-arrow"></span></th>
                        <th data-column="item_code" data-col-index="4">Product Code <span class="sort-arrow"></span></th>
                        <th data-column="description" data-col-index="5">Product Description <span class="sort-arrow"></span></th>
                        <th data-column="special_order_kg" data-col-index="6">Special Order KG <span class="sort-arrow"></span></th>
                        <th data-column="special_order_unit" data-col-index="7">Special Order Unit <span class="sort-arrow"></span></th>
                        <th data-column="requirement_kg" data-col-index="8">Requirement KG <span class="sort-arrow"></span></th>
                        <th data-column="requirement_unit" data-col-index="9">Requirement Unit <span class="sort-arrow"></span></th>
                        <th data-column="avg_weight_per_unit" data-col-index="10">AVG Weight per Unit <span class="sort-arrow"></span></th>
                        <th data-col-index="11">SOH Req KG/Week</th>
                        <th data-column="soh_requirement_units_week" data-col-index="12">SOH Req Units/Week <span class="sort-arrow"></span></th>
                        <th data-col-index="13">SOH KG</th>
                        <th data-col-index="14">SOH Units</th>
                        <th data-column="machinery" data-col-index="15">Machinery <span class="sort-arrow"></span></th>
                        <th data-col-index="16">Total Stock KG</th>
                        <th data-col-index="17">Total Stock Units</th>
                        <th data-column="calculation_factor" data-col-index="18">Calculation Factor <span class="sort-arrow"></span></th>
                        <th data-column="priority" data-col-index="19">Priority <span class="sort-arrow"></span></th>
                        <th data-col-index="20">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in packing_data %}
                    <tr>
                        <td><input type="checkbox" class="packing-select" value="{{ data.packing.id }}"></td>
                        <td>{{ data.week_commencing }}</td>
                        <td>{{ data.packing.packing_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ data.packing.item.item_code }}</td>
                        <td>{{ data.packing.item.description }}</td>
                        <td>{{ data.packing.special_order_kg }}</td>
                        <td>{{ data.special_order_unit }}</td>
                        <td>{{ data.requirement_kg }}</td>
                        <td>{{ data.requirement_unit }}</td>
                        <td>{{ data.packing.item.avg_weight_per_unit }}</td>
                        <td>{{ data.soh_requirement_kg_week }}</td>
                        <td>{{ data.packing.soh_requirement_units_week }}</td>
                        <td>{{ data.soh_kg }}</td>
                        <td>{{ data.soh_units }}</td>
                        <td>{{ data.packing.machinery.machine_name if data.packing.machinery else '' }}</td>
                        <td>{{ data.total_stock_kg }}</td>
                        <td>{{ data.total_stock_units }}</td>
                        <td>{{ data.packing.calculation_factor }}</td>
                        <td>{{ data.packing.priority }}</td>
                        <td>
                            <a href="{{ url_for('packing.packing_edit', id=data.packing.id) }}" class="btn btn-sm btn-primary">Edit</a>
                            <form action="{{ url_for('packing.packing_delete', id=data.packing.id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this packing?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="20" class="no-results">No packing records found.</td></tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="7" style="text-align: right; font-weight: bold; border-right: none;">Total:</td>
                        <td id="total_requirement_kg" style="border-left: none; font-weight: bold;">{{ total_requirement_kg }}</td>
                        <td id="total_requirement_unit" style="font-weight: bold;">{{ total_requirement_unit }}</td>
                        <td colspan="11"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Bulk Edit Modal -->
        <div class="modal fade" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bulkEditModalLabel">Bulk Edit Packing Entries</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="bulkEditForm">
                            <div class="mb-3">
                                <label for="bulk_special_order_kg" class="form-label">Special Order (KG)</label>
                                <input type="number" step="0.01" class="form-control" id="bulk_special_order_kg" name="special_order_kg">
                            </div>
                            <div class="mb-3">
                                <label for="bulk_calculation_factor" class="form-label">Calculation Factor</label>
                                <input type="number" step="0.01" class="form-control" id="bulk_calculation_factor" name="calculation_factor">
                            </div>
                            <div class="mb-3">
                                <label for="bulk_machinery" class="form-label">Machinery</label>
                                <select class="form-control" id="bulk_machinery" name="machinery">
                                    <option value="">Select Machinery</option>
                                    <!-- Machinery options will be populated dynamically via JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="bulk_priority" class="form-label">Priority</label>
                                <input type="number" class="form-control" id="bulk_priority" name="priority">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitBulkEdit()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
    .suggestion-list {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        max-height: 200px;
        overflow-y: auto;
        width: 100%;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .suggestion-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .suggestion-list li {
        padding: 8px 12px;
        cursor: pointer;
    }
    .suggestion-list li:hover {
        background-color: #f5f5f5;
    }
    .form-group {
        margin-bottom: 15px;
    }
    
    /* Style for machinery filter dropdown */
    #search_machinery {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    
    /* Column Toggle Styles */
    #column-toggle {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
    }
    
    #column-toggle h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #495057;
        font-size: 1.1rem;
    }
    
    .column-toggle {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .toggle-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 5px;
    }
    
    .column-toggle label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 0.9rem;
        min-width: 180px;
        padding: 2px 0;
    }
    
    .column-toggle input[type="checkbox"] {
        margin-right: 6px;
        transform: scale(1.1);
    }
    
    .toggle-actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
    }
    
    .toggle-actions button {
        font-size: 0.85rem;
        padding: 4px 8px;
    }
    
    /* Table Styles */
    .table-container {
        overflow-x: auto;
        margin-top: 20px;
    }
    
    .table th {
        white-space: nowrap;
        background-color: #f8f9fa;
        position: relative;
        cursor: pointer;
    }
    
    .sort-arrow {
        display: inline-block;
        width: 0;
        height: 0;
        margin-left: 5px;
        vertical-align: middle;
    }
    
    .sort-arrow.asc {
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-bottom: 4px solid #333;
    }
    
    .sort-arrow.desc {
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 4px solid #333;
    }
    
    .table td {
        white-space: nowrap;
    }
    
    .no-results {
        text-align: center;
        font-style: italic;
        color: #666;
    }
</style>

<script>
    // Initialize machinery filter options
    fetch('/packing/machinery_options')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('search_machinery');
            const bulkSelect = document.getElementById('bulk_machinery');
            data.forEach(machinery => {
                const option = new Option(machinery.machineryName, machinery.machineID);
                select.add(option.cloneNode(true));
                bulkSelect.add(option);
            });
        })
        .catch(error => console.error('Error loading machinery options:', error));

    // Product code autocomplete
    let typingTimer;
    const doneTypingInterval = 300;

    document.getElementById('search_fg_code').addEventListener('input', function() {
        clearTimeout(typingTimer);
        const query = this.value.trim();
        
        if (query) {
            typingTimer = setTimeout(() => {
                fetch(`/packing/autocomplete_packing?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        const suggestionList = document.getElementById('fg_code_suggestions');
                        if (data.length > 0) {
                            const ul = document.createElement('ul');
                            data.forEach(item => {
                                const li = document.createElement('li');
                                li.textContent = `${item.fg_code} - ${item.description}`;
                                li.addEventListener('click', () => {
                                    document.getElementById('search_fg_code').value = item.fg_code;
                                    document.getElementById('search_description').value = item.description;
                                    suggestionList.innerHTML = '';
                                });
                                ul.appendChild(li);
                            });
                            suggestionList.innerHTML = '';
                            suggestionList.appendChild(ul);
            } else {
                            suggestionList.innerHTML = '';
            }
                    })
                    .catch(error => console.error('Error:', error));
            }, doneTypingInterval);
        } else {
            document.getElementById('fg_code_suggestions').innerHTML = '';
        }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.matches('#search_fg_code')) {
            document.getElementById('fg_code_suggestions').innerHTML = '';
        }
    });

    // Fetch packings with search parameters and sorting
    function fetchPackings() {
        const searchParams = new URLSearchParams({
            fg_code: document.getElementById('search_fg_code').value,
            description: document.getElementById('search_description').value,
            packing_date_start: document.getElementById('search_packing_date_start').value,
            packing_date_end: document.getElementById('search_packing_date_end').value,
            week_commencing: document.getElementById('search_week_commencing').value,
            machinery: document.getElementById('search_machinery').value,
            sort_by: currentSortColumn,
            sort_order: currentSortOrder
        });

        fetch(`/packing/search?${searchParams}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#packingListTable tbody');
                tbody.innerHTML = '';

                if (data.packings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="20" class="no-results">No packing records found.</td></tr>';
                    document.getElementById('total_requirement_kg').textContent = '0';
                    document.getElementById('total_requirement_unit').textContent = '0';
        return;
    }

            let totalRequirementKg = 0;
            let totalRequirementUnit = 0;

                data.packings.forEach(packing => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="packing-select" value="${packing.id}"></td>
                        <td>${packing.week_commencing}</td>
                        <td>${packing.packing_date}</td>
                        <td>${packing.item.item_code}</td>
                        <td>${packing.item.description}</td>
                        <td>${packing.special_order_kg}</td>
                        <td>${packing.special_order_unit}</td>
                        <td>${packing.requirement_kg}</td>
                        <td>${packing.requirement_unit}</td>
                        <td>${packing.item.avg_weight_per_unit}</td>
                        <td>${packing.soh_requirement_kg_week}</td>
                        <td>${packing.soh_requirement_units_week}</td>
                        <td>${packing.soh_kg}</td>
                        <td>${packing.soh_units}</td>
                        <td>${packing.machinery ? packing.machinery.machine_name : ''}</td>
                        <td>${packing.total_stock_kg}</td>
                        <td>${packing.total_stock_units}</td>
                        <td>${packing.calculation_factor}</td>
                        <td>${packing.priority}</td>
                        <td>
                            <a href="/packing/edit/${packing.id}" class="btn btn-sm btn-primary">Edit</a>
                            <form action="/packing/delete/${packing.id}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this packing?')">Delete</button>
                            </form>
                        </td>
                    `;
                    tbody.appendChild(row);

                    totalRequirementKg += parseFloat(packing.requirement_kg) || 0;
                    totalRequirementUnit += parseInt(packing.requirement_unit) || 0;
                });

                document.getElementById('total_requirement_kg').textContent = totalRequirementKg.toFixed(2);
                document.getElementById('total_requirement_unit').textContent = totalRequirementUnit;
            })
            .catch(error => console.error('Error:', error));
    }

    // Sorting functionality
    let currentSortColumn = '';
    let currentSortOrder = '';

    document.querySelectorAll('th[data-column]').forEach(th => {
        th.addEventListener('click', () => {
            const column = th.dataset.column;
            
            // Reset all arrows
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.textContent = '';
            });

            if (currentSortColumn === column) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
                currentSortColumn = column;
                currentSortOrder = 'asc';
            }

            // Update arrow
            th.querySelector('.sort-arrow').textContent = currentSortOrder === 'asc' ? ' ↑' : ' ↓';

            fetchPackings();
        });
    });

    // Column visibility functions
    function toggleColumn(colIndex) {
    const table = document.getElementById('packingListTable');
        const cells = table.getElementsByTagName('tr');
        
        for (let i = 0; i < cells.length; i++) {
            const cell = cells[i].getElementsByTagName('td')[colIndex-1] || 
                        cells[i].getElementsByTagName('th')[colIndex-1];
            if (cell) {
                cell.style.display = document.querySelector(`input[data-col-index="${colIndex}"]`).checked ? '' : 'none';
            }
        }
    }

    function showEssentialColumns() {
        const essentialColumns = [2, 3, 4, 5, 8, 9, 15, 19, 20]; // Week Commencing, Date, Product, Description, Req KG, Req Unit, Machinery, Priority, Actions
        document.querySelectorAll('.column-toggle input[type="checkbox"]').forEach(checkbox => {
            const colIndex = parseInt(checkbox.dataset.colIndex);
            checkbox.checked = essentialColumns.includes(colIndex);
            toggleColumn(colIndex);
        });
        
        // Update total row positioning for essential columns view
        updateTotalRowForEssentialView();
    }
    
    function updateTotalRowForEssentialView() {
        const totalRow = document.querySelector('tfoot tr');
        if (totalRow) {
            // For essential view, adjust the total row to align with requirement columns
            totalRow.innerHTML = `
                <td colspan="7" style="text-align: right; font-weight: bold; border-right: none;">Total:</td>
                <td id="total_requirement_kg" style="border-left: none; font-weight: bold;">${document.getElementById('total_requirement_kg').textContent}</td>
                <td id="total_requirement_unit" style="font-weight: bold;">${document.getElementById('total_requirement_unit').textContent}</td>
                <td colspan="11"></td>
            `;
        }
    }

    function showAllColumns() {
        document.querySelectorAll('.column-toggle input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
            toggleColumn(parseInt(checkbox.dataset.colIndex));
        });
}

function resetToDefault() {
        const defaultColumns = [2, 3, 6, 7, 10, 12, 15, 18, 19]; // Your default visible columns
        document.querySelectorAll('.column-toggle input[type="checkbox"]').forEach(checkbox => {
            const colIndex = parseInt(checkbox.dataset.colIndex);
            checkbox.checked = defaultColumns.includes(colIndex);
            toggleColumn(colIndex);
        });
    }

    // Initialize column visibility
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.column-toggle input[type="checkbox"]').forEach(checkbox => {
            toggleColumn(parseInt(checkbox.dataset.colIndex));
        });
    });

    // Bulk edit functionality
function submitBulkEdit() {
        const selectedIds = Array.from(document.querySelectorAll('.packing-select:checked')).map(cb => cb.value);
    if (selectedIds.length === 0) {
            alert('Please select at least one packing entry to edit.');
        return;
    }

        const data = {
        ids: selectedIds,
            special_order_kg: document.getElementById('bulk_special_order_kg').value || null,
            calculation_factor: document.getElementById('bulk_calculation_factor').value || null,
            machinery: document.getElementById('bulk_machinery').value || null,
            priority: document.getElementById('bulk_priority').value || null
        };

        fetch('/packing/bulk_edit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating entries');
        });
    }

    // Select all functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        document.querySelectorAll('.packing-select').forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // Export to Excel functionality
    function exportToExcel() {
        const searchParams = new URLSearchParams({
            fg_code: document.getElementById('search_fg_code').value,
            description: document.getElementById('search_description').value,
            packing_date_start: document.getElementById('search_packing_date_start').value,
            packing_date_end: document.getElementById('search_packing_date_end').value,
            week_commencing: document.getElementById('search_week_commencing').value,
            machinery: document.getElementById('search_machinery').value
        });

        window.location.href = `/packing/export?${searchParams}`;
}
</script>
{% endblock %}