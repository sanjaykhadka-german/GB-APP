{% extends 'index.html' %}

{% block nav %}
    {% set current_page = 'inventory' %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2>Edit Inventory</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="week_commencing" class="form-label">Week Commencing</label>
                    <input type="date" class="form-control" id="week_commencing" name="week_commencing" value="{{ inventory.week_commencing.strftime('%Y-%m-%d') }}" required>
                </div>

                <div class="mb-3">
                    <label for="item_id" class="form-label">Item</label>
                    <select class="form-control" id="item_id" name="item_id" required>
                        <option value="">Select Item</option>
                        {% for item in items %}
                        <option value="{{ item.id }}" {% if item.id == inventory.item_id %}selected{% endif %}>{{ item.description }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="category_id" class="form-label">Category</label>
                    <select class="form-control" id="category_id" name="category_id" required>
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id == inventory.category_id %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="price_per_kg" class="form-label">Price/KG</label>
                    <input type="number" step="0.01" class="form-control" id="price_per_kg" name="price_per_kg" value="{{ "%.2f"|format(inventory.price_per_kg|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="required_total_production" class="form-label">Required Total Production</label>
                    <input type="number" step="0.01" class="form-control" id="required_total_production" name="required_total_production" value="{{ "%.2f"|format(inventory.required_total_production|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="value_required_rm" class="form-label">Value Required RM</label>
                    <input type="number" step="0.01" class="form-control" id="value_required_rm" name="value_required_rm" value="{{ "%.2f"|format(inventory.value_required_rm|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="current_stock" class="form-label">SOH</label>
                    <input type="number" step="0.01" class="form-control" id="current_stock" name="current_stock" value="{{ "%.2f"|format(inventory.current_stock|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="required_for_plan" class="form-label">Required for Plan</label>
                    <input type="number" step="0.01" class="form-control" id="required_for_plan" name="required_for_plan" value="{{ "%.2f"|format(inventory.required_for_plan|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="variance_week" class="form-label">Variance Week</label>
                    <input type="number" step="0.01" class="form-control" id="variance_week" name="variance_week" value="{{ "%.2f"|format(inventory.variance_week|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="kg_required" class="form-label">KG Required</label>
                    <input type="number" step="0.01" class="form-control" id="kg_required" name="kg_required" value="{{ "%.2f"|format(inventory.kg_required|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="variance" class="form-label">Variance</label>
                    <input type="number" step="0.01" class="form-control" id="variance" name="variance" value="{{ "%.2f"|format(inventory.variance|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="to_be_ordered" class="form-label">To Be Ordered</label>
                    <input type="number" step="0.01" class="form-control" id="to_be_ordered" name="to_be_ordered" value="{{ "%.2f"|format(inventory.to_be_ordered|float) }}" required>
                </div>

                <div class="mb-3">
                    <label for="closing_stock" class="form-label">Closing Stock</label>
                    <input type="number" step="0.01" class="form-control" id="closing_stock" name="closing_stock" value="{{ "%.2f"|format(inventory.closing_stock|float) }}" required>
                </div>

                <button type="submit" class="btn btn-primary">Update Inventory</button>
                <a href="{{ url_for('inventory.list_inventory') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </form>
</div>

<script>
document.getElementById('item_id').addEventListener('change', function() {
    const itemId = this.value;
    if (itemId) {
        fetch(`/inventory/api/item/${itemId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('price_per_kg').value = data.price_per_kg || 0;
                document.getElementById('category_id').value = data.category_id || '';
            })
            .catch(error => console.error('Error:', error));
    }
});

document.getElementById('required_total_production').addEventListener('input', function() {
    const requiredTotal = parseFloat(this.value) || 0;
    const pricePerKg = parseFloat(document.getElementById('price_per_kg').value) || 0;
    document.getElementById('value_required_rm').value = (requiredTotal * pricePerKg).toFixed(2);
});

document.getElementById('current_stock').addEventListener('input', function() {
    calculateVariances();
});

document.getElementById('required_for_plan').addEventListener('input', function() {
    calculateVariances();
});

document.getElementById('kg_required').addEventListener('input', function() {
    calculateVariances();
});

function calculateVariances() {
    const currentStock = parseFloat(document.getElementById('current_stock').value) || 0;
    const requiredForPlan = parseFloat(document.getElementById('required_for_plan').value) || 0;
    const kgRequired = parseFloat(document.getElementById('kg_required').value) || 0;
    
    document.getElementById('variance_week').value = (currentStock - requiredForPlan).toFixed(2);
    document.getElementById('variance').value = (currentStock - kgRequired).toFixed(2);
}
</script>
{% endblock %}