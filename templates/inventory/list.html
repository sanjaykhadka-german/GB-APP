{% extends "index.html" %}

{% block content %}
<div class="container-fluid">
    <h1>Inventory List</h1>

    <!-- Search Section -->
    <div class="search-section mb-4">
        <form method="GET" class="form-inline">
            <div class="form-group mx-2">
                <input type="text" class="form-control" name="item" placeholder="Search by item" value="{{ search_item }}">
            </div>
            <div class="form-group mx-2">
                <input type="text" class="form-control" name="category" placeholder="Search by category" value="{{ search_category }}">
            </div>
            <div class="form-group mx-2">
                <input type="date" class="form-control" name="week_commencing" value="{{ search_week_commencing }}">
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
            <button type="button" class="btn btn-success ml-2" onclick="initializeSelectedWeek()">Initialize Selected Week</button>
        </form>
    </div>

    <!-- Inventory Table -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Item Code</th>
                    <th>Description</th>
                    <th>Required Total</th>
                    <th>Price per KG</th>
                    <th>Value Required</th>
                    <th>Current Stock</th>
                    <th>Supplier Name</th>
                    <th>Monday</th>
                    <th>Tuesday</th>
                    <th>Wednesday</th>
                    <th>Thursday</th>
                    <th>Friday</th>
                </tr>
            </thead>
            <tbody>
                {% for item in inventory %}
                <tr>
                    <td>{{ item.item_code }}</td>
                    <td>{{ item.description }}</td>
                    <td class="editable-cell" data-field="required_total">{{ "%.2f"|format(item.required_total|float) }}</td>
                    <td class="editable-cell" data-field="price_per_kg">{{ "%.2f"|format(item.price_per_kg|float) }}</td>
                    <td>{{ "%.2f"|format(item.value_required|float) }}</td>
                    <td class="editable-cell" data-field="current_stock">{{ "%.2f"|format(item.current_stock|float) }}</td>
                    <td>{{ item.supplier_name }}</td>
                    <td>{{ "%.2f"|format(item.daily_required.get(search_week_commencing|default(''), 0)|float) }}</td>
                    <td>{{ "%.2f"|format(item.daily_required.get((search_week_commencing|default('')|datetime_add_days(1)), 0)|float) }}</td>
                    <td>{{ "%.2f"|format(item.daily_required.get((search_week_commencing|default('')|datetime_add_days(2)), 0)|float) }}</td>
                    <td>{{ "%.2f"|format(item.daily_required.get((search_week_commencing|default('')|datetime_add_days(3)), 0)|float) }}</td>
                    <td>{{ "%.2f"|format(item.daily_required.get((search_week_commencing|default('')|datetime_add_days(4)), 0)|float) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add this at the end of your template -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="{{ url_for('static', filename='js/inventory.js') }}"></script>

<script>
function initializeSelectedWeek() {
    var weekCommencing = document.querySelector('input[name="week_commencing"]').value;
    if (!weekCommencing) {
        alert('Please select a week first');
        return;
    }
    
    fetch(`/inventory/initialize/${weekCommencing}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Inventory initialized successfully');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error initializing inventory');
    });
}
</script>
{% endblock %}