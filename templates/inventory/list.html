{% extends 'index.html' %}

{% block nav %}
    {% set current_page = 'inventory' %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2>Inventory List</h2>

    <!-- Search Section -->
    <section id="search" class="mb-4">
        <h3>Search Inventory</h3>
        <form id="searchForm">
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search_item">Item:</label>
                        <input type="text" class="form-control" id="search_item" placeholder="Search by item">
                    </div>
                </div>
                <div class="col-md-3">
            <div class="form-group">
                <label for="search_category">Category:</label>
                        <select class="form-control" id="search_category">
                    <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                </select>
            </div>
            </div>
                <div class="col-md-3">
            <div class="form-group">
                <label for="search_week_commencing">Week Commencing:</label>
                        <input type="date" class="form-control" id="search_week_commencing">
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="searchInventory()">Search</button>
            <button type="button" class="btn btn-secondary" onclick="resetSearch()">Reset</button>
        </form>
    </section>

    <!-- Column Visibility Toggle Section -->
    <section id="column-toggle" class="mb-4">
        <h3>Column Visibility</h3>
        <div class="column-toggle">
            <div class="toggle-row">
                <label><input type="checkbox" checked data-col-index="0" onchange="updateColumnVisibility(this)"> Week Commencing</label>
                <label><input type="checkbox" checked data-col-index="1" onchange="updateColumnVisibility(this)"> Item</label>
                <label><input type="checkbox" checked data-col-index="2" onchange="updateColumnVisibility(this)"> Required Total Production</label>
                <label><input type="checkbox" checked data-col-index="3" onchange="updateColumnVisibility(this)"> Category</label>
                <label><input type="checkbox" checked data-col-index="4" onchange="updateColumnVisibility(this)"> Price/KG</label>
            </div>
            <div class="toggle-row">
                <label><input type="checkbox" checked data-col-index="5" onchange="updateColumnVisibility(this)"> Value Required RM</label>
                <label><input type="checkbox" checked data-col-index="6" onchange="updateColumnVisibility(this)"> SOH</label>
                <label><input type="checkbox" checked data-col-index="7" onchange="updateColumnVisibility(this)"> Supplier Name</label>
                <label><input type="checkbox" checked data-col-index="8" onchange="updateColumnVisibility(this)"> Required for Plan</label>
            </div>
            <div class="toggle-row">
                <label><input type="checkbox" checked data-col-index="9" onchange="updateColumnVisibility(this)"> Variance Week</label>
                <label><input type="checkbox" checked data-col-index="10" onchange="updateColumnVisibility(this)"> KG Required</label>
                <label><input type="checkbox" checked data-col-index="11" onchange="updateColumnVisibility(this)"> Variance</label>
                <label><input type="checkbox" checked data-col-index="12" onchange="updateColumnVisibility(this)"> To Be Ordered</label>
                <label><input type="checkbox" checked data-col-index="13" onchange="updateColumnVisibility(this)"> Closing Stock</label>
            </div>
            <div class="toggle-row">
                <label><input type="checkbox" checked data-col-index="14" onchange="updateColumnVisibility(this)"> Monday</label>
                <label><input type="checkbox" checked data-col-index="15" onchange="updateColumnVisibility(this)"> Tuesday</label>
                <label><input type="checkbox" checked data-col-index="16" onchange="updateColumnVisibility(this)"> Wednesday</label>
                <label><input type="checkbox" checked data-col-index="17" onchange="updateColumnVisibility(this)"> Thursday</label>
                <label><input type="checkbox" checked data-col-index="18" onchange="updateColumnVisibility(this)"> Friday</label>
                <label><input type="checkbox" checked data-col-index="19" onchange="updateColumnVisibility(this)"> Saturday</label>
                <label><input type="checkbox" checked data-col-index="20" onchange="updateColumnVisibility(this)"> Sunday</label>
            </div>
            <div class="toggle-actions">
                <button type="button" class="btn btn-sm btn-secondary" onclick="showEssentialColumns()">Show Essential Only</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="showAllColumns()">Show All</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="resetToDefault()">Reset to Default</button>
                <button type="button" class="btn btn-sm btn-info" onclick="showDailyView()">Show Daily View</button>
                <button type="button" class="btn btn-sm btn-info" onclick="showSummaryView()">Show Summary View</button>
            </div>
        </div>
    </section>

    <div class="mb-3">
        <a href="{{ url_for('inventory.create_inventory') }}" class="btn btn-primary">Add New Inventory</a>
        <button type="button" class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
    </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
        {% endwith %}

    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="inventoryTable">
            <thead class="table-dark">
                <tr>
                    <th data-column="week_commencing">Week Commencing <span class="sort-arrow"></span></th>
                    <th data-column="item">Item <span class="sort-arrow"></span></th>
                    <th data-column="required_total_production">Required Total Production <span class="sort-arrow"></span></th>
                    <th data-column="category">Category <span class="sort-arrow"></span></th>
                    <th data-column="price_per_kg">Price/KG <span class="sort-arrow"></span></th>
                    <th data-column="value_required_rm">Value Required RM <span class="sort-arrow"></span></th>
                    <th data-column="current_stock">SOH <span class="sort-arrow"></span></th>
                    <th data-column="supplier_name">Supplier Name <span class="sort-arrow"></span></th>
                    <th data-column="required_for_plan">Required for Plan <span class="sort-arrow"></span></th>
                    <th data-column="variance_week">Variance Week <span class="sort-arrow"></span></th>
                    <th data-column="kg_required">KG Required <span class="sort-arrow"></span></th>
                    <th data-column="variance">Variance <span class="sort-arrow"></span></th>
                    <th data-column="to_be_ordered">To Be Ordered <span class="sort-arrow"></span></th>
                    <th data-column="closing_stock">Closing Stock <span class="sort-arrow"></span></th>
                    <th data-column="monday" class="daily-column">Monday <span class="sort-arrow"></span></th>
                    <th data-column="tuesday" class="daily-column">Tuesday <span class="sort-arrow"></span></th>
                    <th data-column="wednesday" class="daily-column">Wednesday <span class="sort-arrow"></span></th>
                    <th data-column="thursday" class="daily-column">Thursday <span class="sort-arrow"></span></th>
                    <th data-column="friday" class="daily-column">Friday <span class="sort-arrow"></span></th>
                    <th data-column="saturday" class="daily-column">Saturday <span class="sort-arrow"></span></th>
                    <th data-column="sunday" class="daily-column">Sunday <span class="sort-arrow"></span></th>
                    <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for inventory in inventories %}
                <tr>
                    <td>{{ inventory.week_commencing.strftime('%Y-%m-%d') }}</td>
                    <td>{{ inventory.item.description }}</td>
                    <td>{{ "%.2f"|format(inventory.required_total_production|float) }}</td>
                    <td>{{ inventory.category.name }}</td>
                    <td>{{ "%.2f"|format(inventory.price_per_kg|float) }}</td>
                    <td>{{ "%.2f"|format(inventory.value_required_rm|float) }}</td>
                    <td>{{ "%.2f"|format(inventory.current_stock|float) }}</td>
                    <td>{{ inventory.item.supplier_name or 'N/A' }}</td>
                    <td>{{ "%.2f"|format(inventory.required_for_plan|float) }}</td>
                    <td>{{ "%.2f"|format(inventory.variance_week|float) }}</td>
                    <td>{{ "%.2f"|format(inventory.kg_required|float) }}</td>
                    <td>{{ "%.2f"|format(inventory.variance|float) }}</td>
                    <td>{{ "%.2f"|format(inventory.to_be_ordered|float) }}</td>
                    <td>{{ "%.2f"|format(inventory.closing_stock|float) }}</td>
                    <td class="daily-column">{{ "%.2f"|format(inventory.monday|float) }}</td>
                    <td class="daily-column">{{ "%.2f"|format(inventory.tuesday|float) }}</td>
                    <td class="daily-column">{{ "%.2f"|format(inventory.wednesday|float) }}</td>
                    <td class="daily-column">{{ "%.2f"|format(inventory.thursday|float) }}</td>
                    <td class="daily-column">{{ "%.2f"|format(inventory.friday|float) }}</td>
                    <td class="daily-column">{{ "%.2f"|format(inventory.saturday|float) }}</td>
                    <td class="daily-column">{{ "%.2f"|format(inventory.sunday|float) }}</td>
                    <td>
                        <a href="{{ url_for('inventory.edit_inventory', id=inventory.id) }}" class="btn btn-sm btn-primary">Edit</a>
                        <button class="btn btn-sm btn-danger" onclick="deleteInventory('{{ inventory.id }}')">Delete</button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
</div>

<style>
.daily-column {
    background-color: #e3f2fd !important;
    font-weight: 500;
}
.table-bordered th, .table-bordered td {
        border: 1px solid #dee2e6;
    }
.table-responsive {
        overflow-x: auto;
    }
</style>

<script>
function deleteInventory(id) {
    if (confirm('Are you sure you want to delete this inventory record?')) {
        fetch(`/inventory/delete/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// Column visibility functions
function toggleColumn(colIndex, checked) {
    const table = document.getElementById('inventoryTable');
    const rows = table.getElementsByTagName('tr');
    
    Array.from(rows).forEach(row => {
        const cells = row.cells;
        if (cells.length && colIndex < cells.length) {
            cells[colIndex].style.display = checked ? '' : 'none';
        }
    });
}

function updateColumnVisibility(checkbox) {
    const colIndex = parseInt(checkbox.dataset.colIndex);
    toggleColumn(colIndex, checkbox.checked);
}

function showEssentialColumns() {
    const essentialColumns = [0, 1, 2, 3, 4]; // Week Commencing, Item, Required Total Production, Category, Price/KG
    const checkboxes = document.querySelectorAll('.column-toggle input[type="checkbox"]');
    
    checkboxes.forEach((checkbox, index) => {
        const isEssential = essentialColumns.includes(index);
        checkbox.checked = isEssential;
        toggleColumn(index, isEssential);
    });
}

function showAllColumns() {
    const checkboxes = document.querySelectorAll('.column-toggle input[type="checkbox"]');
    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = true;
        toggleColumn(index, true);
    });
}

function resetToDefault() {
    const defaultColumns = [0, 1, 2, 3, 4, 5, 6, 7, 8]; // First 9 columns
    const checkboxes = document.querySelectorAll('.column-toggle input[type="checkbox"]');
    
    checkboxes.forEach((checkbox, index) => {
        const isDefault = defaultColumns.includes(index);
        checkbox.checked = isDefault;
        toggleColumn(index, isDefault);
    });
}

// Additional view functions
function showDailyView() {
    // Show only essential columns + daily columns
    const dailyViewColumns = [0, 1, 14, 15, 16, 17, 18, 19, 20]; // Week, Item, Mon-Sun
    const checkboxes = document.querySelectorAll('.column-toggle input[type="checkbox"]');
    
    checkboxes.forEach((checkbox, index) => {
        const shouldShow = dailyViewColumns.includes(index);
        checkbox.checked = shouldShow;
        toggleColumn(index, shouldShow);
    });
}

function showSummaryView() {
    // Show summary columns only
    const summaryColumns = [0, 1, 2, 3, 4, 5, 6, 8, 9, 10, 11, 12, 13]; // All except daily
    const checkboxes = document.querySelectorAll('.column-toggle input[type="checkbox"]');
    
    checkboxes.forEach((checkbox, index) => {
        const shouldShow = summaryColumns.includes(index);
        checkbox.checked = shouldShow;
        toggleColumn(index, shouldShow);
    });
}

// Export to Excel function
function exportToExcel() {
    // Get visible data
    const table = document.getElementById('inventoryTable');
    const wb = XLSX.utils.table_to_book(table, {sheet: "Inventory"});
    XLSX.writeFile(wb, `inventory_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// Initialize column visibility controls
document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners for column toggles
    const checkboxes = document.querySelectorAll('.column-toggle input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateColumnVisibility(this);
        });
    });
});

// Search functions
function searchInventory() {
    const item = document.getElementById('search_item').value.toLowerCase();
    const category = document.getElementById('search_category').value;
    const weekCommencing = document.getElementById('search_week_commencing').value;
    
    const table = document.getElementById('inventoryTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        if (cells.length) {
            const itemText = cells[1].textContent.toLowerCase();
            const categoryText = cells[3].textContent;
            const weekCommencingText = cells[0].textContent;
            
            const matchItem = item === '' || itemText.includes(item);
            const matchCategory = category === '' || categoryText === category;
            const matchWeek = weekCommencing === '' || weekCommencingText.includes(weekCommencing);
            
            row.style.display = (matchItem && matchCategory && matchWeek) ? '' : 'none';
        }
    }
}

function resetSearch() {
    document.getElementById('search_item').value = '';
    document.getElementById('search_category').value = '';
    document.getElementById('search_week_commencing').value = '';
    searchInventory();
}
</script>

<!-- Add XLSX library for Excel export -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
{% endblock %}